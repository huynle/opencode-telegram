# Docker Compose for OpenCode Telegram Bot
#
# IMPORTANT: Running natively with `bun run start` is recommended for full functionality.
# Docker has limitations - see README.md for details.
#
# Limitations in Docker:
# - Session discovery (ps/lsof) only sees container processes, not host processes
# - /sessions and /connect commands won't find OpenCode instances on your host
# - On macOS/Windows, --network=host doesn't provide true host networking
#
# Docker works well for:
# - Managed instances only (created via /new command)
# - Linux with --pid=host for full discovery
# - Using the External API to manually register instances

version: '3.8'

services:
  opencode-telegram:
    build: .
    container_name: opencode-telegram
    
    # Required: Host network for communicating with OpenCode instances
    network_mode: host
    
    # Optional (Linux only): Uncomment to enable session discovery
    # WARNING: This shares the host's process namespace - the container can see all host processes
    # pid: host
    
    volumes:
      # Persist SQLite databases across restarts
      - ./data:/app/data
      
      # Project directories created by /new command
      - ~/oc-bot:/root/oc-bot
      
      # Optional: Mount additional project directories if needed
      # - ~/projects:/root/projects
    
    env_file:
      - .env
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4200/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
